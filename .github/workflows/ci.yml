name: Continuous Integration

on:
  pull_request:
  push:
    branches:
      - main
      - 'releases/*'
  workflow_dispatch:

jobs:
  compare-github:
    name: Diff to OG ${{matrix.ref}} d=${{ matrix.fetch-depth }}
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]

    strategy:
      fail-fast: false
      matrix:
        ref:
          - "" # action target
          - "main" # unqualified, to be resolved
          - "v7.1.0" # unqualified, to be resolved
          - "65866b8ec2b20cb1433fa38ff8771832b90ac322" # specific commit
          - "9a889919b07f093332488f55290d18b4a37cab91" # specific commit - not on main
          - "refs/heads/test-data/v2/basic" # a branch
          - "refs/tags/v7.1.0" # a tag
        fetch-depth:
          - 0 # full history
          - 1 # shallow clone

    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Github checkout
        uses: actions/checkout@v4
        with:
          path: github-current
          ref: ${{ matrix.ref }}
          fetch-depth: ${{ matrix.fetch-depth }}
      - name: Namespace Checkout
        uses: ./ # Uses an action in the root directory
        with:
          path: nscloud-current
          ref: ${{ matrix.ref }}
          fetch-depth: ${{ matrix.fetch-depth }}
      - name: Compare checkouts
        run: .github/tests/compare-checkouts.sh github-current nscloud-current dist/index.js

  basic-checkout:
    name: Basic checkout tests
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Basic checkout tests
        uses: ./
        with: 
          ref: test-data/v2/basic
          path: basic
      - name: Verify basic
        shell: bash
        run: .github/tests/verify-basic.sh

  side-by-side:
    name: Side-by-side example
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Checkout side by side 1
        uses: ./
        with:
          ref: test-data/v2/side-by-side-1
          path: side-by-side-1
      - name: Checkout side by side 2
        uses: ./
        with:
          ref: test-data/v2/side-by-side-2
          path: side-by-side-2
      - name: Verify side by side
        shell: bash
        run: .github/tests/verify-side-by-side.sh

  lfs:
    name: LFS example
    strategy:
      matrix:
        runs-on:
          - nscloud-ubuntu-22.04-amd64-2x4
          - nscloud-macos-sequoia-stable-arm64-4x7
    runs-on:
      - "${{ matrix.runs-on }}-with-cache"
      - nscloud-git-mirror-5gb
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Checkout LFS
        uses: ./
        with:
          repository: namespacelabs/nscloud-checkout-action # hardcoded, otherwise doesn't work from a fork
          ref: test-data/v2/lfs
          path: lfs
          lfs: true
      - name: Verify LFS
        shell: bash
        run: .github/tests/verify-lfs.sh

  submodules:
    name: Submodules=${{ matrix.variant }}
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    strategy:
      fail-fast: false
      matrix:
        variant:
          - false
          - true
          - recursive
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Checkout submodules=${{ matrix.variant }}
        uses: ./
        with:
          ref: test-data/v2/submodule-ssh-url
          path: submodules-${{ matrix.variant }}
          submodules: ${{ matrix.variant }}
      - name: Verify submodules=${{ matrix.variant }}
        run: .github/tests/verify-submodules-${{ matrix.variant }}.sh

  deleted-pull: # NSL-6725
    name: Check out deleted PR
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Namespace Checkout
        uses: ./
        with:
          path: pr
          ref: "refs/pull/1/merge" # this ref doesn't exist but will be synthesized from commit
          commit: "65866b8ec2b20cb1433fa38ff8771832b90ac322" # hidden input
          fetch-depth: 1
      - name: Verify checkouts
        run: .github/tests/verify-head-and-ref.sh pr 65866b8ec2b20cb1433fa38ff8771832b90ac322 refs/remotes/pull/1/merge

  fetch-more: # NSL-6774
    name: Another branch (${{ matrix.fetch && 'shallow, ' || 'deep, ' }} ${{ matrix.dissociate && 'dissociate, ' || ''}}${{ matrix.fetch && 'fetch, ' || ''}}checkout)
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    strategy:
      fail-fast: false
      matrix:
        dissociate:
          - false
          - true
        fetch:
          - false
          - true
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Check out main
        uses: ./
        with:
          ref: main
          path: repo
          fetch-depth: ${{ matrix.fetch && 1 || 0 }} # if we are not fetching we should be deep-cloned from get-go
          dissociate: ${{ matrix.dissociate }} # if set, fetch will download from remote
      - name: Inspect checkout
        run: git show-ref
        working-directory: repo
      - name: Fetch another branch
        run: git fetch --progress origin test-data/v2/basic
        working-directory: repo
        if: matrix.fetch
      - name: Check out that branch
        run: git checkout test-data/v2/basic
        working-directory: repo
      - name: Verify checkout
        run: sdiff <(echo test-data/v2/basic) <(git branch --show-current)
        working-directory: repo

  trace:
    name: Git tracing enabled
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Checkout with tracing
        uses: ./
        with:
          ref: test-data/v2/basic
          path: traced
          trace: true
      - name: Verify trace output was produced
        run: |
          # The checkout should have succeeded and trace output should have been visible in logs
          test -d traced
          test -f traced/README.md

  orphan-commit:
    name: Checkout orphaned commit
    runs-on: [nscloud-ubuntu-22.04-amd64-2x4-with-cache, nscloud-git-mirror-5gb]
    steps:
      - name: Check out action
        uses: actions/checkout@v4
      - name: Checkout orphaned commit by SHA
        uses: ./
        with:
          # This commit was pushed and its branch was then deleted, making it orphaned
          ref: 0fdac2a7c55231d1a3e964ac055907c7dbe56e9b
          path: orphan
          fetch-depth: 0
      - name: Verify orphaned commit checkout
        run: |
          test -f orphan/orphan-test.txt
          grep -q "This commit will be orphaned" orphan/orphan-test.txt
